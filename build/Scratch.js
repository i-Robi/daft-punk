/**
 * @file Guitar engine.
 * @author SÃ©bastien Robaszkiewicz [sebastien@robaszkiewicz.com]
 */

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var EventEmitter = require('events').EventEmitter;

function speed(a, b) {
  var dX = a[0] - b[0];
  var dY = a[1] - b[1];
  var dT = b[2] - a[2];

  if (dX !== 0 && dY !== 0 && dT !== 0) return [Math.sqrt(dX * dX + dY * dY) / dT, b[2]];

  return [0, b[2]];
}

function acc(a, b) {
  var dS = b[0] - a[0];
  var dT = b[1] - a[1];

  if (dS !== 0 && dT !== 0) return [dS / dT, b[1]];

  return [0, b[1]];
}

function getTime() {
  return window.performance && window.performance.now ? window.performance.now() / 1000 : new Date().getTime() / 1000;
}

/**
 * @class LowPassFilter
 * @description Applies a low-pass filter.
 */

var LowPassFilter = (function () {
  function LowPassFilter(timeConstant) {
    _classCallCheck(this, LowPassFilter);

    this._XFiltered;
    this._previousTimestamp;
    this._timeConstant = timeConstant;
  }

  _createClass(LowPassFilter, [{
    key: '_decay',
    value: function _decay(dt) {
      return Math.exp(-2 * Math.PI * dt / this._timeConstant);
    }
  }, {
    key: 'input',
    value: function input(x) {
      var now = getTime();

      if (this._previousTimestamp) {
        var dt = now - this._previousTimestamp;
        var k = this._decay(dt);

        this._XFiltered = k * this._XFiltered + (1 - k) * x;
        this._previousTimestamp = now;

        return this._XFiltered;
      } else {
        this._previousTimestamp = now;
        this._XFiltered = x;
        return;
      }
    }
  }]);

  return LowPassFilter;
})();

var Scratch = (function (_EventEmitter) {
  _inherits(Scratch, _EventEmitter);

  function Scratch() {
    var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Scratch);

    _get(Object.getPrototypeOf(Scratch.prototype), 'constructor', this).call(this);

    this.event = null;

    this._bufferLength = options.bufferLength || 5;
    this._filter = new LowPassFilter(0.05);
    this._surface = options.surface || document;
    this._timeout = null;

    this._x = null;
    this._y = null;
    this._s = null;
    this._lastX = null;
    this._lastY = null;
    this._lastS = null;
    this._acc = null;

    this._surface.addEventListener('mousemove', this.onMotion.bind(this));
    this._surface.addEventListener('touchmove', this.onMotion.bind(this));
  }

  _createClass(Scratch, [{
    key: 'onMotion',
    value: function onMotion(e) {
      var timestamp = e.timeStamp / 1000;
      var x = undefined;
      var y = undefined;

      switch (e.type) {
        case 'mousemove':
          x = e.clientX;
          y = e.clientY;
          break;
        case 'touchmove':
          x = e.changedTouches[0].clientX;
          y = e.changedTouches[0].clientY;
          break;
      }

      var pos = [x, y, timestamp];

      if (this._pos) {
        this._lastS = this._s;
        this._s = speed(pos, this._pos);
      }

      if (this._lastS) this._acc = acc(this._s, this._lastS);

      this._pos = [x, y, timestamp];

      if (this._acc) {
        this.event = this._filter.input(Math.min(Math.abs(this._acc[0] / 100000), 1));
      }

      this.emit('scratch', this.event);

      clearTimeout(this._timeout);
      this._timeout = this.timeoutFun();
    }
  }, {
    key: 'timeoutFun',
    value: function timeoutFun() {
      var _this = this;

      return setTimeout(function () {
        _this.event = _this._filter.input(0);
        _this.emit('scratch', _this.event);
        _this._timeout = _this.timeoutFun();
      }, 50);
    }
  }]);

  return Scratch;
})(EventEmitter);

module.exports = Scratch;
//# sourceMappingURL=data:application/json;base64,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LENBQUMsSUFBSSxFQUFFO0FBQ2IsWUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FDN0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQzdDLENBQUM7T0FDSDs7QUFFRCxVQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRWpDLGtCQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzVCLFVBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0tBQ25DOzs7V0FFUyxzQkFBRzs7O0FBQ1gsYUFBTyxVQUFVLENBQUMsWUFBTTtBQUN0QixjQUFLLEtBQUssR0FBRyxNQUFLLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkMsY0FBSyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQUssS0FBSyxDQUFDLENBQUM7QUFDakMsY0FBSyxRQUFRLEdBQUcsTUFBSyxVQUFVLEVBQUUsQ0FBQztPQUNuQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ1I7OztTQXJFRyxPQUFPO0dBQVMsWUFBWTs7QUF5RWxDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDIiwiZmlsZSI6InNyYy9zY3NzL21haW4uc2NzcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgR3VpdGFyIGVuZ2luZS5cbiAqIEBhdXRob3IgU8OpYmFzdGllbiBSb2Jhc3praWV3aWN6IFtzZWJhc3RpZW5Acm9iYXN6a2lld2ljei5jb21dXG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG5cbmZ1bmN0aW9uIHNwZWVkKGEsIGIpIHtcbiAgY29uc3QgZFggPSBhWzBdIC0gYlswXTtcbiAgY29uc3QgZFkgPSBhWzFdIC0gYlsxXTtcbiAgY29uc3QgZFQgPSBiWzJdIC0gYVsyXTtcblxuICBpZiAoZFggIT09IDAgJiYgZFkgIT09IDAgJiYgZFQgIT09IDApXG4gICAgcmV0dXJuIFtNYXRoLnNxcnQoZFggKiBkWCArIGRZICogZFkpIC8gZFQsIGJbMl1dO1xuXG4gIHJldHVybiBbMCwgYlsyXV07XG59XG5cbmZ1bmN0aW9uIGFjYyhhLCBiKSB7XG4gIGNvbnN0IGRTID0gYlswXSAtIGFbMF07XG4gIGNvbnN0IGRUID0gYlsxXSAtIGFbMV07XG5cbiAgaWYgKGRTICE9PSAwICYmIGRUICE9PSAwKVxuICAgIHJldHVybiBbZFMgLyBkVCwgYlsxXV07XG5cbiAgcmV0dXJuIFswLCBiWzFdXTtcbn1cblxuZnVuY3Rpb24gZ2V0VGltZSgpIHtcbiAgcmV0dXJuICh3aW5kb3cucGVyZm9ybWFuY2UgJiYgd2luZG93LnBlcmZvcm1hbmNlLm5vdykgP1xuICAgIHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKSAvIDEwMDAgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDA7XG59XG5cbi8qKlxuICogQGNsYXNzIExvd1Bhc3NGaWx0ZXJcbiAqIEBkZXNjcmlwdGlvbiBBcHBsaWVzIGEgbG93LXBhc3MgZmlsdGVyLlxuICovXG5jbGFzcyBMb3dQYXNzRmlsdGVyIHtcbiAgY29uc3RydWN0b3IodGltZUNvbnN0YW50KSB7XG4gICAgdGhpcy5fWEZpbHRlcmVkO1xuICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wO1xuICAgIHRoaXMuX3RpbWVDb25zdGFudCA9IHRpbWVDb25zdGFudDtcbiAgfVxuXG4gIF9kZWNheShkdCkge1xuICAgIHJldHVybiBNYXRoLmV4cCgtMiAqIE1hdGguUEkgKiBkdCAvIHRoaXMuX3RpbWVDb25zdGFudCk7XG4gIH1cblxuICBpbnB1dCh4KSB7XG4gICAgY29uc3Qgbm93ID0gZ2V0VGltZSgpO1xuXG4gICAgaWYgKHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wKcKge1xuICAgICAgY29uc3QgZHQgPSBub3cgLSB0aGlzLl9wcmV2aW91c1RpbWVzdGFtcDtcbiAgICAgIGNvbnN0IGsgPSB0aGlzLl9kZWNheShkdCk7XG5cbiAgICAgIHRoaXMuX1hGaWx0ZXJlZCA9IGsgKiB0aGlzLl9YRmlsdGVyZWQgKyAoMSAtIGspICogeDtcbiAgICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wID0gbm93O1xuXG4gICAgICByZXR1cm4gdGhpcy5fWEZpbHRlcmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9wcmV2aW91c1RpbWVzdGFtcCA9IG5vdztcbiAgICAgIHRoaXMuX1hGaWx0ZXJlZCA9IHg7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFNjcmF0Y2ggZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5ldmVudCA9IG51bGw7XG5cbiAgICB0aGlzLl9idWZmZXJMZW5ndGggPSBvcHRpb25zLmJ1ZmZlckxlbmd0aCB8fCA1O1xuICAgIHRoaXMuX2ZpbHRlciA9IG5ldyBMb3dQYXNzRmlsdGVyKDAuMDUpO1xuICAgIHRoaXMuX3N1cmZhY2UgPSBvcHRpb25zLnN1cmZhY2UgfHwgZG9jdW1lbnQ7XG4gICAgdGhpcy5fdGltZW91dCA9IG51bGw7XG5cbiAgICB0aGlzLl94ID0gbnVsbDtcbiAgICB0aGlzLl95ID0gbnVsbDtcbiAgICB0aGlzLl9zID0gbnVsbDtcbiAgICB0aGlzLl9sYXN0WCA9IG51bGw7XG4gICAgdGhpcy5fbGFzdFkgPSBudWxsO1xuICAgIHRoaXMuX2xhc3RTID0gbnVsbDtcbiAgICB0aGlzLl9hY2MgPSBudWxsO1xuXG4gICAgdGhpcy5fc3VyZmFjZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLm9uTW90aW9uLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX3N1cmZhY2UuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5vbk1vdGlvbi5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG9uTW90aW9uKGUpIHtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBlLnRpbWVTdGFtcCAvIDEwMDA7XG4gICAgbGV0IHg7XG4gICAgbGV0IHk7XG5cbiAgICBzd2l0Y2ggKGUudHlwZSkge1xuICAgICAgY2FzZSAnbW91c2Vtb3ZlJzpcbiAgICAgICAgeCA9IGUuY2xpZW50WDtcbiAgICAgICAgeSA9IGUuY2xpZW50WTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0b3VjaG1vdmUnOlxuICAgICAgICB4ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYO1xuICAgICAgICB5ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRZO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBwb3MgPSBbeCwgeSwgdGltZXN0YW1wXTtcblxuICAgIGlmICh0aGlzLl9wb3MpIHtcbiAgICAgIHRoaXMuX2xhc3RTID0gdGhpcy5fcztcbiAgICAgIHRoaXMuX3MgPSBzcGVlZChwb3MsIHRoaXMuX3Bvcyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2xhc3RTKVxuICAgICAgdGhpcy5fYWNjID0gYWNjKHRoaXMuX3MsIHRoaXMuX2xhc3RTKTtcblxuICAgIHRoaXMuX3BvcyA9IFt4LCB5LCB0aW1lc3RhbXBdO1xuXG4gICAgaWYgKHRoaXMuX2FjYykge1xuICAgICAgdGhpcy5ldmVudCA9IHRoaXMuX2ZpbHRlci5pbnB1dChcbiAgICAgICAgTWF0aC5taW4oTWF0aC5hYnModGhpcy5fYWNjWzBdIC8gMTAwMDAwKSwgMSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdzY3JhdGNoJywgdGhpcy5ldmVudCk7XG5cbiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCk7XG4gICAgdGhpcy5fdGltZW91dCA9IHRoaXMudGltZW91dEZ1bigpO1xuICB9XG5cbiAgdGltZW91dEZ1bigpIHtcbiAgICByZXR1cm4gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50ID0gdGhpcy5fZmlsdGVyLmlucHV0KDApO1xuICAgICAgdGhpcy5lbWl0KCdzY3JhdGNoJywgdGhpcy5ldmVudCk7XG4gICAgICB0aGlzLl90aW1lb3V0ID0gdGhpcy50aW1lb3V0RnVuKCk7XG4gICAgfSwgNTApO1xuICB9XG5cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTY3JhdGNoO1xuIl19