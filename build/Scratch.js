/**
 * @file Scratch
 * @author SÃ©bastien Robaszkiewicz [sebastien@robaszkiewicz.com]
 * @description Converts the action of scratching the screen or moving the
 * mouse into an energy value between 0 and 1.
 */

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var EventEmitter = require('events').EventEmitter;

function speed(startPosition, endPosition) {
  var dX = endPosition[0] - startPosition[0];
  var dY = endPosition[1] - startPosition[1];
  var dT = endPosition[2] - startPosition[2];
  var timestamp = endPosition[2];

  if (dT !== 0) return [Math.sqrt(dX * dX + dY * dY) / dT, timestamp];

  return [0, timestamp];
}

function acc(startSpeed, endSpeed) {
  var dS = endSpeed[0] - startSpeed[0];
  var dT = endSpeed[1] - startSpeed[1];
  var timestamp = endSpeed[1];

  if (dT !== 0) return [dS / dT, timestamp];

  return [0, timestamp];
}

function getTime() {
  return window.performance && window.performance.now ? window.performance.now() / 1000 : new Date().getTime() / 1000;
}

/**
 * @class LowPassFilter
 * @description Applies a low-pass filter.
 */

var LowPassFilter = (function () {
  function LowPassFilter(timeConstant) {
    _classCallCheck(this, LowPassFilter);

    this._XFiltered;
    this._previousTimestamp;
    this._timeConstant = timeConstant;
  }

  _createClass(LowPassFilter, [{
    key: '_decay',
    value: function _decay(dt) {
      return Math.exp(-2 * Math.PI * dt / this._timeConstant);
    }
  }, {
    key: 'input',
    value: function input(x) {
      var now = getTime();

      if (this._previousTimestamp) {
        var dt = now - this._previousTimestamp;
        var k = this._decay(dt);

        this._XFiltered = k * this._XFiltered + (1 - k) * x;
        this._previousTimestamp = now;

        return this._XFiltered;
      } else {
        this._previousTimestamp = now;
        this._XFiltered = x;
        return;
      }
    }
  }]);

  return LowPassFilter;
})();

var Scratch = (function (_EventEmitter) {
  _inherits(Scratch, _EventEmitter);

  function Scratch() {
    var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Scratch);

    _get(Object.getPrototypeOf(Scratch.prototype), 'constructor', this).call(this);

    this.event = null;

    this._bufferLength = options.bufferLength || 5;
    this._filter = new LowPassFilter(0.05);
    this._surface = options.surface || document;
    this._timeout = null;

    this._x = null;
    this._y = null;
    this._s = null;
    this._lastS = null;
    this._acc = null;

    this._surface.addEventListener('mousemove', this.onMotion.bind(this));
    this._surface.addEventListener('touchmove', this.onMotion.bind(this));
  }

  _createClass(Scratch, [{
    key: 'onMotion',
    value: function onMotion(e) {
      // /!\ BUG
      // As of Safari 9.0 (11601.1.56) for Mac OS X 10.11 (15A284), Safari
      // triggers each mousemove event twice unless the mouse button is down while
      // dragging).
      var timestamp = e.timeStamp / 1000;
      var x = undefined;
      var y = undefined;

      switch (e.type) {
        case 'mousemove':
          x = e.clientX;
          y = e.clientY;
          break;
        case 'touchmove':
          x = e.changedTouches[0].clientX;
          y = e.changedTouches[0].clientY;
          break;
      }

      var pos = [x, y, timestamp];

      if (this._pos) {
        this._lastS = this._s; // remains null the first time onMotion is called
        this._s = speed(this._pos, pos);
      }

      if (this._lastS) this._acc = acc(this._lastS, this._s);

      this._pos = pos;

      if (this._acc) {
        var accValue = Math.min(Math.abs(this._acc[0] / 100000), 1);
        this.event = this._filter.input(accValue);
      }

      this.emit('scratch', this.event);

      clearTimeout(this._timeout);
      this._timeout = this.timeoutFun();
    }
  }, {
    key: 'timeoutFun',
    value: function timeoutFun() {
      var _this = this;

      return setTimeout(function () {
        _this.event = _this._filter.input(0);
        _this.emit('scratch', _this.event);
        _this._timeout = _this.timeoutFun();
      }, 50);
    }
  }]);

  return Scratch;
})(EventEmitter);

module.exports = Scratch;
//# sourceMappingURL=data:application/json;base64,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QUFDLENBQUMsQ0FBQztBQUM5RCxZQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO09BQzNDOztBQUVELFVBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFakMsa0JBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUIsVUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7S0FDbkM7OztXQUVTLHNCQUFHOzs7QUFDWCxhQUFPLFVBQVUsQ0FBQyxZQUFNO0FBQ3RCLGNBQUssS0FBSyxHQUFHLE1BQUssT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQyxjQUFLLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBSyxLQUFLLENBQUMsQ0FBQztBQUNqQyxjQUFLLFFBQVEsR0FBRyxNQUFLLFVBQVUsRUFBRSxDQUFDO09BQ25DLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDUjs7O1NBdEVHLE9BQU87R0FBUyxZQUFZOztBQTBFbEMsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMiLCJmaWxlIjoic3JjL2pzL1NjcmF0Y2guanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIFNjcmF0Y2hcbiAqIEBhdXRob3IgU8OpYmFzdGllbiBSb2Jhc3praWV3aWN6IFtzZWJhc3RpZW5Acm9iYXN6a2lld2ljei5jb21dXG4gKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIGFjdGlvbiBvZiBzY3JhdGNoaW5nIHRoZSBzY3JlZW4gb3IgbW92aW5nIHRoZVxuICogbW91c2UgaW50byBhbiBlbmVyZ3kgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLlxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xuXG5mdW5jdGlvbiBzcGVlZChzdGFydFBvc2l0aW9uLCBlbmRQb3NpdGlvbikge1xuICBjb25zdCBkWCA9IGVuZFBvc2l0aW9uWzBdIC0gc3RhcnRQb3NpdGlvblswXTtcbiAgY29uc3QgZFkgPSBlbmRQb3NpdGlvblsxXSAtIHN0YXJ0UG9zaXRpb25bMV07XG4gIGNvbnN0IGRUID0gZW5kUG9zaXRpb25bMl0gLSBzdGFydFBvc2l0aW9uWzJdO1xuICBjb25zdCB0aW1lc3RhbXAgPSBlbmRQb3NpdGlvblsyXTtcblxuICBpZiAoZFQgIT09IDApXG4gICAgcmV0dXJuIFtNYXRoLnNxcnQoZFggKiBkWCArIGRZICogZFkpIC8gZFQsIHRpbWVzdGFtcF07XG5cbiAgcmV0dXJuIFswLCB0aW1lc3RhbXBdO1xufVxuXG5mdW5jdGlvbiBhY2Moc3RhcnRTcGVlZCwgZW5kU3BlZWQpIHtcbiAgY29uc3QgZFMgPSBlbmRTcGVlZFswXSAtIHN0YXJ0U3BlZWRbMF07XG4gIGNvbnN0IGRUID0gZW5kU3BlZWRbMV0gLSBzdGFydFNwZWVkWzFdO1xuICBjb25zdCB0aW1lc3RhbXAgPSBlbmRTcGVlZFsxXTtcblxuICBpZiAoZFQgIT09IDApXG4gICAgcmV0dXJuIFtkUyAvIGRULCB0aW1lc3RhbXBdO1xuXG4gIHJldHVybiBbMCwgdGltZXN0YW1wXTtcbn1cblxuZnVuY3Rpb24gZ2V0VGltZSgpIHtcbiAgcmV0dXJuICh3aW5kb3cucGVyZm9ybWFuY2UgJiYgd2luZG93LnBlcmZvcm1hbmNlLm5vdykgP1xuICAgIHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKSAvIDEwMDAgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDA7XG59XG5cbi8qKlxuICogQGNsYXNzIExvd1Bhc3NGaWx0ZXJcbiAqIEBkZXNjcmlwdGlvbiBBcHBsaWVzIGEgbG93LXBhc3MgZmlsdGVyLlxuICovXG5jbGFzcyBMb3dQYXNzRmlsdGVyIHtcbiAgY29uc3RydWN0b3IodGltZUNvbnN0YW50KSB7XG4gICAgdGhpcy5fWEZpbHRlcmVkO1xuICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wO1xuICAgIHRoaXMuX3RpbWVDb25zdGFudCA9IHRpbWVDb25zdGFudDtcbiAgfVxuXG4gIF9kZWNheShkdCkge1xuICAgIHJldHVybiBNYXRoLmV4cCgtMiAqIE1hdGguUEkgKiBkdCAvIHRoaXMuX3RpbWVDb25zdGFudCk7XG4gIH1cblxuICBpbnB1dCh4KSB7XG4gICAgY29uc3Qgbm93ID0gZ2V0VGltZSgpO1xuXG4gICAgaWYgKHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wKcKge1xuICAgICAgY29uc3QgZHQgPSBub3cgLSB0aGlzLl9wcmV2aW91c1RpbWVzdGFtcDtcbiAgICAgIGNvbnN0IGsgPSB0aGlzLl9kZWNheShkdCk7XG5cbiAgICAgIHRoaXMuX1hGaWx0ZXJlZCA9IGsgKiB0aGlzLl9YRmlsdGVyZWQgKyAoMSAtIGspICogeDtcbiAgICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wID0gbm93O1xuXG4gICAgICByZXR1cm4gdGhpcy5fWEZpbHRlcmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9wcmV2aW91c1RpbWVzdGFtcCA9IG5vdztcbiAgICAgIHRoaXMuX1hGaWx0ZXJlZCA9IHg7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFNjcmF0Y2ggZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5ldmVudCA9IG51bGw7XG5cbiAgICB0aGlzLl9idWZmZXJMZW5ndGggPSBvcHRpb25zLmJ1ZmZlckxlbmd0aCB8fCA1O1xuICAgIHRoaXMuX2ZpbHRlciA9IG5ldyBMb3dQYXNzRmlsdGVyKDAuMDUpO1xuICAgIHRoaXMuX3N1cmZhY2UgPSBvcHRpb25zLnN1cmZhY2UgfHwgZG9jdW1lbnQ7XG4gICAgdGhpcy5fdGltZW91dCA9IG51bGw7XG5cbiAgICB0aGlzLl94ID0gbnVsbDtcbiAgICB0aGlzLl95ID0gbnVsbDtcbiAgICB0aGlzLl9zID0gbnVsbDtcbiAgICB0aGlzLl9sYXN0UyA9IG51bGw7XG4gICAgdGhpcy5fYWNjID0gbnVsbDtcblxuICAgIHRoaXMuX3N1cmZhY2UuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5vbk1vdGlvbi5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLl9zdXJmYWNlLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMub25Nb3Rpb24uYmluZCh0aGlzKSk7XG4gIH1cblxuICBvbk1vdGlvbihlKSB7XG4gICAgLy8gLyFcXCBCVUdcbiAgICAvLyBBcyBvZiBTYWZhcmkgOS4wICgxMTYwMS4xLjU2KSBmb3IgTWFjIE9TIFggMTAuMTEgKDE1QTI4NCksIFNhZmFyaVxuICAgIC8vIHRyaWdnZXJzIGVhY2ggbW91c2Vtb3ZlIGV2ZW50IHR3aWNlIHVubGVzcyB0aGUgbW91c2UgYnV0dG9uIGlzIGRvd24gd2hpbGVcbiAgICAvLyBkcmFnZ2luZykuXG4gICAgY29uc3QgdGltZXN0YW1wID0gZS50aW1lU3RhbXAgLyAxMDAwO1xuICAgIGxldCB4O1xuICAgIGxldCB5O1xuXG4gICAgc3dpdGNoIChlLnR5cGUpIHtcbiAgICAgIGNhc2UgJ21vdXNlbW92ZSc6XG4gICAgICAgIHggPSBlLmNsaWVudFg7XG4gICAgICAgIHkgPSBlLmNsaWVudFk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndG91Y2htb3ZlJzpcbiAgICAgICAgeCA9IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WDtcbiAgICAgICAgeSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3QgcG9zID0gW3gsIHksIHRpbWVzdGFtcF07XG5cbiAgICBpZiAodGhpcy5fcG9zKSB7XG4gICAgICB0aGlzLl9sYXN0UyA9IHRoaXMuX3M7IC8vIHJlbWFpbnMgbnVsbCB0aGUgZmlyc3QgdGltZSBvbk1vdGlvbiBpcyBjYWxsZWRcbiAgICAgIHRoaXMuX3MgPSBzcGVlZCh0aGlzLl9wb3MsIHBvcyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2xhc3RTKVxuICAgICAgdGhpcy5fYWNjID0gYWNjKHRoaXMuX2xhc3RTLCB0aGlzLl9zKTtcblxuICAgIHRoaXMuX3BvcyA9IHBvcztcblxuICAgIGlmICh0aGlzLl9hY2MpIHtcbiAgICAgIGNvbnN0IGFjY1ZhbHVlID0gTWF0aC5taW4oTWF0aC5hYnModGhpcy5fYWNjWzBdIC8gMTAwMDAwKSwgMSk7XG4gICAgICB0aGlzLmV2ZW50ID0gdGhpcy5fZmlsdGVyLmlucHV0KGFjY1ZhbHVlKTtcbiAgICB9XG5cbiAgICB0aGlzLmVtaXQoJ3NjcmF0Y2gnLCB0aGlzLmV2ZW50KTtcblxuICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KTtcbiAgICB0aGlzLl90aW1lb3V0ID0gdGhpcy50aW1lb3V0RnVuKCk7XG4gIH1cblxuICB0aW1lb3V0RnVuKCkge1xuICAgIHJldHVybiBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuZXZlbnQgPSB0aGlzLl9maWx0ZXIuaW5wdXQoMCk7XG4gICAgICB0aGlzLmVtaXQoJ3NjcmF0Y2gnLCB0aGlzLmV2ZW50KTtcbiAgICAgIHRoaXMuX3RpbWVvdXQgPSB0aGlzLnRpbWVvdXRGdW4oKTtcbiAgICB9LCA1MCk7XG4gIH1cblxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFNjcmF0Y2g7XG4iXX0=