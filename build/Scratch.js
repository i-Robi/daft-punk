/**
 * @file Scratch
 * @author SÃ©bastien Robaszkiewicz [sebastien@robaszkiewicz.com]
 * @description Converts the action of scratching the screen or moving the
 * mouse into an energy value between 0 and 1.
 */

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var EventEmitter = require('events').EventEmitter;

function speed(startPosition, endPosition) {
  var dX = endPosition[0] - startPosition[0];
  var dY = endPosition[1] - startPosition[1];
  var dT = endPosition[2] - startPosition[2];
  var timestamp = endPosition[2];

  if (dT !== 0) return [Math.sqrt(dX * dX + dY * dY) / dT, timestamp];

  return [0, timestamp];
}

function acc(startSpeed, endSpeed) {
  var dS = endSpeed[0] - startSpeed[0];
  var dT = endSpeed[1] - startSpeed[1];
  var timestamp = endSpeed[1];

  if (dT !== 0) return [dS / dT, timestamp];

  return [0, timestamp];
}

function getTime() {
  return window.performance && window.performance.now ? window.performance.now() / 1000 : new Date().getTime() / 1000;
}

/**
 * @class LowPassFilter
 * @description Applies a low-pass filter.
 */

var LowPassFilter = (function () {
  function LowPassFilter(timeConstant) {
    _classCallCheck(this, LowPassFilter);

    this._XFiltered;
    this._previousTimestamp;
    this._timeConstant = timeConstant;
  }

  _createClass(LowPassFilter, [{
    key: '_decay',
    value: function _decay(dt) {
      return Math.exp(-2 * Math.PI * dt / this._timeConstant);
    }
  }, {
    key: 'input',
    value: function input(x) {
      var now = getTime();

      if (this._previousTimestamp) {
        var dt = now - this._previousTimestamp;
        var k = this._decay(dt);

        this._XFiltered = k * this._XFiltered + (1 - k) * x;
        this._previousTimestamp = now;

        return this._XFiltered;
      } else {
        this._previousTimestamp = now;
        this._XFiltered = x;
        return;
      }
    }
  }]);

  return LowPassFilter;
})();

var Scratch = (function (_EventEmitter) {
  _inherits(Scratch, _EventEmitter);

  function Scratch() {
    var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Scratch);

    _get(Object.getPrototypeOf(Scratch.prototype), 'constructor', this).call(this);

    this.event = null;

    this._bufferLength = options.bufferLength || 5;
    this._filter = new LowPassFilter(0.05);
    this._surface = options.surface || document;
    this._timeout = null;

    this._x = null;
    this._y = null;
    this._s = null;
    this._lastS = null;
    this._acc = null;

    this._surface.addEventListener('mousemove', this.onMotion.bind(this));
    this._surface.addEventListener('touchmove', this.onMotion.bind(this));
  }

  _createClass(Scratch, [{
    key: 'onMotion',
    value: function onMotion(e) {
      // /!\ BUG
      // As of Safari 9.0 (11601.1.56) for Mac OS X 10.11 (15A284), Safari
      // triggers each mousemove event twice unless the mouse button is down while
      // dragging).
      var timestamp = e.timeStamp / 1000;
      var x = undefined;
      var y = undefined;

      switch (e.type) {
        case 'mousemove':
          x = e.clientX;
          y = e.clientY;
          break;
        case 'touchmove':
          x = e.changedTouches[0].clientX;
          y = e.changedTouches[0].clientY;
          break;
      }

      var pos = [x, y, timestamp];

      if (this._pos) {
        this._lastS = this._s; // remains null the first time onMotion is called
        this._s = speed(this._pos, pos);
      }

      if (this._lastS) this._acc = acc(this._lastS, this._s);

      this._pos = pos;

      if (this._acc) {
        var accValue = Math.min(Math.abs(this._acc[0] / 100000), 1);
        this.event = this._filter.input(accValue);
      }

      this.emit('scratch', this.event);

      clearTimeout(this._timeout);
      this._timeout = this.timeoutFun();
    }
  }, {
    key: 'timeoutFun',
    value: function timeoutFun() {
      var _this = this;

      return setTimeout(function () {
        _this.event = _this._filter.input(0);
        _this.emit('scratch', _this.event);
        _this._timeout = _this.timeoutFun();
      }, 50);
    }
  }]);

  return Scratch;
})(EventEmitter);

module.exports = Scratch;
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxDQUFDLENBQUM7QUFDOUQsWUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztPQUMzQzs7QUFFRCxVQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRWpDLGtCQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzVCLFVBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0tBQ25DOzs7V0FFUyxzQkFBRzs7O0FBQ1gsYUFBTyxVQUFVLENBQUMsWUFBTTtBQUN0QixjQUFLLEtBQUssR0FBRyxNQUFLLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkMsY0FBSyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQUssS0FBSyxDQUFDLENBQUM7QUFDakMsY0FBSyxRQUFRLEdBQUcsTUFBSyxVQUFVLEVBQUUsQ0FBQztPQUNuQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ1I7OztTQXRFRyxPQUFPO0dBQVMsWUFBWTs7QUEwRWxDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDIiwiZmlsZSI6InNyYy9zY3NzL21haW4uc2NzcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgU2NyYXRjaFxuICogQGF1dGhvciBTw6liYXN0aWVuIFJvYmFzemtpZXdpY3ogW3NlYmFzdGllbkByb2Jhc3praWV3aWN6LmNvbV1cbiAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgYWN0aW9uIG9mIHNjcmF0Y2hpbmcgdGhlIHNjcmVlbiBvciBtb3ZpbmcgdGhlXG4gKiBtb3VzZSBpbnRvIGFuIGVuZXJneSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEuXG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG5cbmZ1bmN0aW9uIHNwZWVkKHN0YXJ0UG9zaXRpb24sIGVuZFBvc2l0aW9uKSB7XG4gIGNvbnN0IGRYID0gZW5kUG9zaXRpb25bMF0gLSBzdGFydFBvc2l0aW9uWzBdO1xuICBjb25zdCBkWSA9IGVuZFBvc2l0aW9uWzFdIC0gc3RhcnRQb3NpdGlvblsxXTtcbiAgY29uc3QgZFQgPSBlbmRQb3NpdGlvblsyXSAtIHN0YXJ0UG9zaXRpb25bMl07XG4gIGNvbnN0IHRpbWVzdGFtcCA9IGVuZFBvc2l0aW9uWzJdO1xuXG4gIGlmIChkVCAhPT0gMClcbiAgICByZXR1cm4gW01hdGguc3FydChkWCAqIGRYICsgZFkgKiBkWSkgLyBkVCwgdGltZXN0YW1wXTtcblxuICByZXR1cm4gWzAsIHRpbWVzdGFtcF07XG59XG5cbmZ1bmN0aW9uIGFjYyhzdGFydFNwZWVkLCBlbmRTcGVlZCkge1xuICBjb25zdCBkUyA9IGVuZFNwZWVkWzBdIC0gc3RhcnRTcGVlZFswXTtcbiAgY29uc3QgZFQgPSBlbmRTcGVlZFsxXSAtIHN0YXJ0U3BlZWRbMV07XG4gIGNvbnN0IHRpbWVzdGFtcCA9IGVuZFNwZWVkWzFdO1xuXG4gIGlmIChkVCAhPT0gMClcbiAgICByZXR1cm4gW2RTIC8gZFQsIHRpbWVzdGFtcF07XG5cbiAgcmV0dXJuIFswLCB0aW1lc3RhbXBdO1xufVxuXG5mdW5jdGlvbiBnZXRUaW1lKCkge1xuICByZXR1cm4gKHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2Uubm93KSA/XG4gICAgd2luZG93LnBlcmZvcm1hbmNlLm5vdygpIC8gMTAwMCA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMDtcbn1cblxuLyoqXG4gKiBAY2xhc3MgTG93UGFzc0ZpbHRlclxuICogQGRlc2NyaXB0aW9uIEFwcGxpZXMgYSBsb3ctcGFzcyBmaWx0ZXIuXG4gKi9cbmNsYXNzIExvd1Bhc3NGaWx0ZXIge1xuICBjb25zdHJ1Y3Rvcih0aW1lQ29uc3RhbnQpIHtcbiAgICB0aGlzLl9YRmlsdGVyZWQ7XG4gICAgdGhpcy5fcHJldmlvdXNUaW1lc3RhbXA7XG4gICAgdGhpcy5fdGltZUNvbnN0YW50ID0gdGltZUNvbnN0YW50O1xuICB9XG5cbiAgX2RlY2F5KGR0KSB7XG4gICAgcmV0dXJuIE1hdGguZXhwKC0yICogTWF0aC5QSSAqIGR0IC8gdGhpcy5fdGltZUNvbnN0YW50KTtcbiAgfVxuXG4gIGlucHV0KHgpIHtcbiAgICBjb25zdCBub3cgPSBnZXRUaW1lKCk7XG5cbiAgICBpZiAodGhpcy5fcHJldmlvdXNUaW1lc3RhbXApwqB7XG4gICAgICBjb25zdCBkdCA9IG5vdyAtIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wO1xuICAgICAgY29uc3QgayA9IHRoaXMuX2RlY2F5KGR0KTtcblxuICAgICAgdGhpcy5fWEZpbHRlcmVkID0gayAqIHRoaXMuX1hGaWx0ZXJlZCArICgxIC0gaykgKiB4O1xuICAgICAgdGhpcy5fcHJldmlvdXNUaW1lc3RhbXAgPSBub3c7XG5cbiAgICAgIHJldHVybiB0aGlzLl9YRmlsdGVyZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wID0gbm93O1xuICAgICAgdGhpcy5fWEZpbHRlcmVkID0geDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgU2NyYXRjaCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmV2ZW50ID0gbnVsbDtcblxuICAgIHRoaXMuX2J1ZmZlckxlbmd0aCA9IG9wdGlvbnMuYnVmZmVyTGVuZ3RoIHx8IDU7XG4gICAgdGhpcy5fZmlsdGVyID0gbmV3IExvd1Bhc3NGaWx0ZXIoMC4wNSk7XG4gICAgdGhpcy5fc3VyZmFjZSA9IG9wdGlvbnMuc3VyZmFjZSB8fCBkb2N1bWVudDtcbiAgICB0aGlzLl90aW1lb3V0ID0gbnVsbDtcblxuICAgIHRoaXMuX3ggPSBudWxsO1xuICAgIHRoaXMuX3kgPSBudWxsO1xuICAgIHRoaXMuX3MgPSBudWxsO1xuICAgIHRoaXMuX2xhc3RTID0gbnVsbDtcbiAgICB0aGlzLl9hY2MgPSBudWxsO1xuXG4gICAgdGhpcy5fc3VyZmFjZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLm9uTW90aW9uLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX3N1cmZhY2UuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5vbk1vdGlvbi5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG9uTW90aW9uKGUpIHtcbiAgICAvLyAvIVxcIEJVR1xuICAgIC8vIEFzIG9mIFNhZmFyaSA5LjAgKDExNjAxLjEuNTYpIGZvciBNYWMgT1MgWCAxMC4xMSAoMTVBMjg0KSwgU2FmYXJpXG4gICAgLy8gdHJpZ2dlcnMgZWFjaCBtb3VzZW1vdmUgZXZlbnQgdHdpY2UgdW5sZXNzIHRoZSBtb3VzZSBidXR0b24gaXMgZG93biB3aGlsZVxuICAgIC8vIGRyYWdnaW5nKS5cbiAgICBjb25zdCB0aW1lc3RhbXAgPSBlLnRpbWVTdGFtcCAvIDEwMDA7XG4gICAgbGV0IHg7XG4gICAgbGV0IHk7XG5cbiAgICBzd2l0Y2ggKGUudHlwZSkge1xuICAgICAgY2FzZSAnbW91c2Vtb3ZlJzpcbiAgICAgICAgeCA9IGUuY2xpZW50WDtcbiAgICAgICAgeSA9IGUuY2xpZW50WTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0b3VjaG1vdmUnOlxuICAgICAgICB4ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYO1xuICAgICAgICB5ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRZO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBwb3MgPSBbeCwgeSwgdGltZXN0YW1wXTtcblxuICAgIGlmICh0aGlzLl9wb3MpIHtcbiAgICAgIHRoaXMuX2xhc3RTID0gdGhpcy5fczsgLy8gcmVtYWlucyBudWxsIHRoZSBmaXJzdCB0aW1lIG9uTW90aW9uIGlzIGNhbGxlZFxuICAgICAgdGhpcy5fcyA9IHNwZWVkKHRoaXMuX3BvcywgcG9zKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fbGFzdFMpXG4gICAgICB0aGlzLl9hY2MgPSBhY2ModGhpcy5fbGFzdFMsIHRoaXMuX3MpO1xuXG4gICAgdGhpcy5fcG9zID0gcG9zO1xuXG4gICAgaWYgKHRoaXMuX2FjYykge1xuICAgICAgY29uc3QgYWNjVmFsdWUgPSBNYXRoLm1pbihNYXRoLmFicyh0aGlzLl9hY2NbMF0gLyAxMDAwMDApLCAxKTtcbiAgICAgIHRoaXMuZXZlbnQgPSB0aGlzLl9maWx0ZXIuaW5wdXQoYWNjVmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMuZW1pdCgnc2NyYXRjaCcsIHRoaXMuZXZlbnQpO1xuXG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpO1xuICAgIHRoaXMuX3RpbWVvdXQgPSB0aGlzLnRpbWVvdXRGdW4oKTtcbiAgfVxuXG4gIHRpbWVvdXRGdW4oKSB7XG4gICAgcmV0dXJuIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5ldmVudCA9IHRoaXMuX2ZpbHRlci5pbnB1dCgwKTtcbiAgICAgIHRoaXMuZW1pdCgnc2NyYXRjaCcsIHRoaXMuZXZlbnQpO1xuICAgICAgdGhpcy5fdGltZW91dCA9IHRoaXMudGltZW91dEZ1bigpO1xuICAgIH0sIDUwKTtcbiAgfVxuXG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2NyYXRjaDtcbiJdfQ==