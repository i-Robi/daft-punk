/**
 * @file Interactive version of Daft Punk's Lose Yourself To Dance.
 * @author SÃ©bastien Robaszkiewicz [hello@robi.me]
 */

'use strict';

// Libraries and files

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var audioContext = require('waves-audio').audioContext;
var DotNav = require('./DotNav');
var GuitarEngine = require('./GuitarEngine');
var input = require('motion-input');
var SuperLoader = require('waves-loaders').SuperLoader;
var PlayControl = require('waves-audio').PlayControl;
var PlayerEngine = require('waves-audio').PlayerEngine;
var Transport = require('waves-audio').Transport;

// Helper functions
function startWebAudio() {
  var o = audioContext.createOscillator();
  var g = audioContext.createGain();
  var now = audioContext.currentTime;
  o.connect(g);
  g.connect(audioContext.destination);
  o.start(now);
  o.stop(now + 0.000001);
}

// Helper variables
var webAudioStarted = false;
var playing = false;

// Constants (song specific)
var mode = 0;
var offset = 2.400;
var period = 0.150;

// Script
(function () {
  var loader = new SuperLoader();

  // Prevent scrolling
  document.body.addEventListener('touchmove', function (e) {
    e.preventDefault();
  });

  _Promise.all([loader.load(['assets/backtrack.mp3', 'assets/guitar.mp3', 'assets/guitar-markers.json']), input.init('energy')]).then(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2);

    var loadedFiles = _ref2[0];
    var inputModules = _ref2[1];

    // Files and energy module
    var backtrackBuffer = loadedFiles[0];
    var guitarBuffer = loadedFiles[1];
    var guitarMarkers = loadedFiles[2];
    var energy = inputModules[0];

    // Player engine (backtrack)
    var backtrackPlayer = new PlayerEngine({
      buffer: backtrackBuffer,
      gain: 0.5
    });
    backtrackPlayer.connect(audioContext.destination);

    // Instrument engine (guitar)
    var guitarEngine = new GuitarEngine({
      audioBuffer: guitarBuffer,
      mode: mode,
      offset: offset,
      period: period,
      segmentMarkers: guitarMarkers
    });
    guitarEngine.connect(audioContext.destination);

    // Transport
    var transport = new Transport();
    transport.add(backtrackPlayer, 0, Infinity);
    transport.add(guitarEngine, 0, Infinity);

    // Play control
    var playControl = new PlayControl(transport);

    // Dot navigation
    var nav = document.querySelector('.dot-nav');
    var dotNav = new DotNav({
      callback: guitarEngine.changeMode.bind(guitarEngine),
      nav: nav,
      selected: mode
    });

    // Button
    var button = document.getElementById('button');
    button.addEventListener('click', function () {
      if (!webAudioStarted) {
        startWebAudio();
        webAudioStarted = true;
      }

      if (!playing) {
        playControl.start();
        guitarEngine.start();
        playing = true;
      } else {
        playControl.stop();
        guitarEngine.stop(); // TODO: remove if empty
        playing = false;
      }

      button.querySelector('i').classList.toggle('icon-play');
      button.querySelector('i').classList.toggle('icon-stop');
    });

    // Input module listener
    if (energy.isValid) {
      input.addListener('energy', function (val) {
        guitarEngine.onEnergy(val);
      });
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zY3NzL21haW4uc2NzcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUtBLFlBQVksQ0FBQzs7Ozs7Ozs7QUFHYixJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsWUFBWSxDQUFDO0FBQ3pELElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNuQyxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUMvQyxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFdBQVcsQ0FBQztBQUN6RCxJQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxZQUFZLENBQUM7QUFDekQsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQzs7O0FBR25ELFNBQVMsYUFBYSxHQUFHO0FBQ3ZCLE1BQU0sQ0FBQyxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0FBQzFDLE1BQU0sQ0FBQyxHQUFHLFlBQVksQ0FBQyxVQUFVLEVBQUUsQ0FBQztBQUNwQyxNQUFNLEdBQUcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO0FBQ3JDLEdBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDYixHQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwQyxHQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2IsR0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUM7Q0FDeEI7OztBQUdELElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQztBQUM1QixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7OztBQUdwQixJQUFNLElBQUksR0FBRyxDQUFDLENBQUM7QUFDZixJQUFNLE1BQU0sR0FBRyxLQUFLLENBQUM7QUFDckIsSUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDOzs7QUFHckIsQUFBQyxDQUFBLFlBQVc7QUFDVixNQUFNLE1BQU0sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDOzs7QUFHakMsVUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsVUFBQyxDQUFDLEVBQUs7QUFDakQsS0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO0dBQ3BCLENBQUMsQ0FBQzs7QUFFSCxXQUFRLEdBQUcsQ0FBQyxDQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxzQkFBc0IsRUFBRSxtQkFBbUIsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDLEVBQ3hGLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQ3JCLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUEyQixFQUFLOytCQUFoQyxJQUEyQjs7UUFBMUIsV0FBVztRQUFFLFlBQVk7OztBQUVqQyxRQUFNLGVBQWUsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkMsUUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BDLFFBQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQyxRQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7OztBQUcvQixRQUFNLGVBQWUsR0FBRyxJQUFJLFlBQVksQ0FBQztBQUN2QyxZQUFNLEVBQUUsZUFBZTtBQUN2QixVQUFJLEVBQUUsR0FBRztLQUNWLENBQUMsQ0FBQztBQUNILG1CQUFlLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQzs7O0FBR2xELFFBQU0sWUFBWSxHQUFHLElBQUksWUFBWSxDQUFDO0FBQ3BDLGlCQUFXLEVBQUUsWUFBWTtBQUN6QixVQUFJLEVBQUUsSUFBSTtBQUNWLFlBQU0sRUFBRSxNQUFNO0FBQ2QsWUFBTSxFQUFFLE1BQU07QUFDZCxvQkFBYyxFQUFFLGFBQWE7S0FDOUIsQ0FBQyxDQUFDO0FBQ0gsZ0JBQVksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDOzs7QUFHL0MsUUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztBQUNsQyxhQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDNUMsYUFBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDOzs7QUFHekMsUUFBTSxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7OztBQUcvQyxRQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQy9DLFFBQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDO0FBQ3hCLGNBQVEsRUFBRSxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDcEQsU0FBRyxFQUFFLEdBQUc7QUFDUixjQUFRLEVBQUUsSUFBSTtLQUNmLENBQUMsQ0FBQzs7O0FBR0gsUUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQyxVQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFlBQU07QUFDckMsVUFBSSxDQUFDLGVBQWUsRUFBRTtBQUNwQixxQkFBYSxFQUFFLENBQUM7QUFDaEIsdUJBQWUsR0FBRyxJQUFJLENBQUM7T0FDeEI7O0FBRUQsVUFBSSxDQUFDLE9BQU8sRUFBRTtBQUNaLG1CQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDcEIsb0JBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNyQixlQUFPLEdBQUcsSUFBSSxDQUFDO09BQ2hCLE1BQU07QUFDTCxtQkFBVyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ25CLG9CQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDcEIsZUFBTyxHQUFHLEtBQUssQ0FBQztPQUNqQjs7QUFFRCxZQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDeEQsWUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ3pELENBQUMsQ0FBQzs7O0FBR0gsUUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQ2xCLFdBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLFVBQUMsR0FBRyxFQUFLO0FBQ25DLG9CQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO09BQzVCLENBQUMsQ0FBQztLQUNKO0dBQ0YsQ0FBQyxDQUFDO0NBQ0osQ0FBQSxFQUFFLENBQUUiLCJmaWxlIjoic3JjL3Njc3MvbWFpbi5zY3NzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBJbnRlcmFjdGl2ZSB2ZXJzaW9uIG9mIERhZnQgUHVuaydzIExvc2UgWW91cnNlbGYgVG8gRGFuY2UuXG4gKiBAYXV0aG9yIFPDqWJhc3RpZW4gUm9iYXN6a2lld2ljeiBbaGVsbG9Acm9iaS5tZV1cbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbi8vIExpYnJhcmllcyBhbmQgZmlsZXNcbmNvbnN0IGF1ZGlvQ29udGV4dCA9IHJlcXVpcmUoJ3dhdmVzLWF1ZGlvJykuYXVkaW9Db250ZXh0O1xuY29uc3QgRG90TmF2ID0gcmVxdWlyZSgnLi9Eb3ROYXYnKTtcbmNvbnN0IEd1aXRhckVuZ2luZSA9IHJlcXVpcmUoJy4vR3VpdGFyRW5naW5lJyk7XG5jb25zdCBpbnB1dCA9IHJlcXVpcmUoJ21vdGlvbi1pbnB1dCcpO1xuY29uc3QgU3VwZXJMb2FkZXIgPSByZXF1aXJlKCd3YXZlcy1sb2FkZXJzJykuU3VwZXJMb2FkZXI7XG5jb25zdCBQbGF5Q29udHJvbCA9IHJlcXVpcmUoJ3dhdmVzLWF1ZGlvJykuUGxheUNvbnRyb2w7XG5jb25zdCBQbGF5ZXJFbmdpbmUgPSByZXF1aXJlKCd3YXZlcy1hdWRpbycpLlBsYXllckVuZ2luZTtcbmNvbnN0IFRyYW5zcG9ydCA9IHJlcXVpcmUoJ3dhdmVzLWF1ZGlvJykuVHJhbnNwb3J0O1xuXG4vLyBIZWxwZXIgZnVuY3Rpb25zXG5mdW5jdGlvbiBzdGFydFdlYkF1ZGlvKCkge1xuICBjb25zdCBvID0gYXVkaW9Db250ZXh0LmNyZWF0ZU9zY2lsbGF0b3IoKTtcbiAgY29uc3QgZyA9IGF1ZGlvQ29udGV4dC5jcmVhdGVHYWluKCk7XG4gIGNvbnN0IG5vdyA9IGF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcbiAgby5jb25uZWN0KGcpO1xuICBnLmNvbm5lY3QoYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcbiAgby5zdGFydChub3cpO1xuICBvLnN0b3Aobm93ICsgMC4wMDAwMDEpO1xufVxuXG4vLyBIZWxwZXIgdmFyaWFibGVzXG5sZXQgd2ViQXVkaW9TdGFydGVkID0gZmFsc2U7XG5sZXQgcGxheWluZyA9IGZhbHNlO1xuXG4vLyBDb25zdGFudHMgKHNvbmcgc3BlY2lmaWMpXG5jb25zdCBtb2RlID0gMDtcbmNvbnN0IG9mZnNldCA9IDIuNDAwO1xuY29uc3QgcGVyaW9kID0gMC4xNTA7XG5cbi8vIFNjcmlwdFxuKGZ1bmN0aW9uKCkge1xuICBjb25zdCBsb2FkZXIgPSBuZXcgU3VwZXJMb2FkZXIoKTtcblxuICAvLyBQcmV2ZW50IHNjcm9sbGluZ1xuICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9KTtcblxuICBQcm9taXNlLmFsbChbXG4gICAgbG9hZGVyLmxvYWQoWydhc3NldHMvYmFja3RyYWNrLm1wMycsICdhc3NldHMvZ3VpdGFyLm1wMycsICdhc3NldHMvZ3VpdGFyLW1hcmtlcnMuanNvbiddKSxcbiAgICBpbnB1dC5pbml0KCdlbmVyZ3knKVxuICBdKS50aGVuKChbbG9hZGVkRmlsZXMsIGlucHV0TW9kdWxlc10pID0+IHtcbiAgICAvLyBGaWxlcyBhbmQgZW5lcmd5IG1vZHVsZVxuICAgIGNvbnN0IGJhY2t0cmFja0J1ZmZlciA9IGxvYWRlZEZpbGVzWzBdO1xuICAgIGNvbnN0IGd1aXRhckJ1ZmZlciA9IGxvYWRlZEZpbGVzWzFdO1xuICAgIGNvbnN0IGd1aXRhck1hcmtlcnMgPSBsb2FkZWRGaWxlc1syXTtcbiAgICBjb25zdCBlbmVyZ3kgPSBpbnB1dE1vZHVsZXNbMF07XG5cbiAgICAvLyBQbGF5ZXIgZW5naW5lIChiYWNrdHJhY2spXG4gICAgY29uc3QgYmFja3RyYWNrUGxheWVyID0gbmV3IFBsYXllckVuZ2luZSh7XG4gICAgICBidWZmZXI6IGJhY2t0cmFja0J1ZmZlcixcbiAgICAgIGdhaW46IDAuNVxuICAgIH0pO1xuICAgIGJhY2t0cmFja1BsYXllci5jb25uZWN0KGF1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XG5cbiAgICAvLyBJbnN0cnVtZW50IGVuZ2luZSAoZ3VpdGFyKVxuICAgIGNvbnN0IGd1aXRhckVuZ2luZSA9IG5ldyBHdWl0YXJFbmdpbmUoe1xuICAgICAgYXVkaW9CdWZmZXI6IGd1aXRhckJ1ZmZlcixcbiAgICAgIG1vZGU6IG1vZGUsXG4gICAgICBvZmZzZXQ6IG9mZnNldCxcbiAgICAgIHBlcmlvZDogcGVyaW9kLFxuICAgICAgc2VnbWVudE1hcmtlcnM6IGd1aXRhck1hcmtlcnNcbiAgICB9KTtcbiAgICBndWl0YXJFbmdpbmUuY29ubmVjdChhdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuXG4gICAgLy8gVHJhbnNwb3J0XG4gICAgY29uc3QgdHJhbnNwb3J0ID0gbmV3IFRyYW5zcG9ydCgpO1xuICAgIHRyYW5zcG9ydC5hZGQoYmFja3RyYWNrUGxheWVyLCAwLCBJbmZpbml0eSk7XG4gICAgdHJhbnNwb3J0LmFkZChndWl0YXJFbmdpbmUsIDAsIEluZmluaXR5KTtcblxuICAgIC8vIFBsYXkgY29udHJvbFxuICAgIGNvbnN0IHBsYXlDb250cm9sID0gbmV3IFBsYXlDb250cm9sKHRyYW5zcG9ydCk7XG5cbiAgICAvLyBEb3QgbmF2aWdhdGlvblxuICAgIGNvbnN0IG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kb3QtbmF2Jyk7XG4gICAgY29uc3QgZG90TmF2ID0gbmV3IERvdE5hdih7XG4gICAgICBjYWxsYmFjazogZ3VpdGFyRW5naW5lLmNoYW5nZU1vZGUuYmluZChndWl0YXJFbmdpbmUpLFxuICAgICAgbmF2OiBuYXYsXG4gICAgICBzZWxlY3RlZDogbW9kZVxuICAgIH0pO1xuXG4gICAgLy8gQnV0dG9uXG4gICAgbGV0IGJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidXR0b24nKTtcbiAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICBpZiAoIXdlYkF1ZGlvU3RhcnRlZCkge1xuICAgICAgICBzdGFydFdlYkF1ZGlvKCk7XG4gICAgICAgIHdlYkF1ZGlvU3RhcnRlZCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmICghcGxheWluZykge1xuICAgICAgICBwbGF5Q29udHJvbC5zdGFydCgpO1xuICAgICAgICBndWl0YXJFbmdpbmUuc3RhcnQoKTtcbiAgICAgICAgcGxheWluZyA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwbGF5Q29udHJvbC5zdG9wKCk7XG4gICAgICAgIGd1aXRhckVuZ2luZS5zdG9wKCk7IC8vIFRPRE86IHJlbW92ZSBpZiBlbXB0eVxuICAgICAgICBwbGF5aW5nID0gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGJ1dHRvbi5xdWVyeVNlbGVjdG9yKCdpJykuY2xhc3NMaXN0LnRvZ2dsZSgnaWNvbi1wbGF5Jyk7XG4gICAgICBidXR0b24ucXVlcnlTZWxlY3RvcignaScpLmNsYXNzTGlzdC50b2dnbGUoJ2ljb24tc3RvcCcpO1xuICAgIH0pO1xuXG4gICAgLy8gSW5wdXQgbW9kdWxlIGxpc3RlbmVyXG4gICAgaWYgKGVuZXJneS5pc1ZhbGlkKSB7XG4gICAgICBpbnB1dC5hZGRMaXN0ZW5lcignZW5lcmd5JywgKHZhbCkgPT4ge1xuICAgICAgICBndWl0YXJFbmdpbmUub25FbmVyZ3kodmFsKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59KCkpO1xuIl19