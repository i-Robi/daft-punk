/**
 * @file Interactive version of Daft Punk's Lose Yourself To Dance.
 * @author SÃ©bastien Robaszkiewicz [hello@robi.me]
 */

'use strict';

// Libraries and files

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var audioContext = require('waves-audio').audioContext;
var DotNav = require('./DotNav');
var GuitarEngine = require('./GuitarEngine');
var input = require('motion-input');
var SuperLoader = require('waves-loaders').SuperLoader;
var PlayControl = require('waves-audio').PlayControl;
var PlayerEngine = require('waves-audio').PlayerEngine;
var Transport = require('waves-audio').Transport;

// Helper functions
function startWebAudio() {
  var o = audioContext.createOscillator();
  var g = audioContext.createGain();
  var now = audioContext.currentTime;
  o.connect(g);
  g.connect(audioContext.destination);
  o.start(now);
  o.stop(now + 0.000001);
}

// Helper variables
var webAudioStarted = false;
var playing = false;

// Initialization & constants
var loader = new SuperLoader();
var offset = 2.400;
var period = 0.150;

// Script
(function () {
  // Prevent scrolling
  document.body.addEventListener('touchmove', function (e) {
    e.preventDefault();
  });

  _Promise.all([loader.load(['assets/backtrack.mp3', 'assets/guitar.mp3', 'assets/guitar-markers.json']), input.init('energy')]).then(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2);

    var loadedFiles = _ref2[0];
    var inputModules = _ref2[1];

    // Files and energy module
    var backtrackBuffer = loadedFiles[0];
    var guitarBuffer = loadedFiles[1];
    var guitarMarkers = loadedFiles[2];
    var energy = inputModules[0];

    // Player engine (backtrack)
    var backtrackPlayer = new PlayerEngine({
      buffer: backtrackBuffer,
      gain: 0.5
    });
    backtrackPlayer.connect(audioContext.destination);

    // Instrument engine (guitar)
    var guitarEngine = new GuitarEngine({
      audioBuffer: guitarBuffer,
      mode: 0,
      offset: offset,
      period: period,
      segmentMarkers: guitarMarkers
    });
    guitarEngine.connect(audioContext.destination);

    // Transport
    var transport = new Transport();
    transport.add(backtrackPlayer, 0, Infinity);
    transport.add(guitarEngine, 0, Infinity);

    // Play control
    var playControl = new PlayControl(transport);

    // Dot navigation
    var nav = document.querySelector('.dot-nav');
    var dotNav = new DotNav({
      callback: guitarEngine.changeMode.bind(guitarEngine),
      nav: nav,
      selected: 1
    });

    // Button
    var button = document.getElementById('button');
    button.addEventListener('click', function () {
      if (!webAudioStarted) {
        startWebAudio();
        webAudioStarted = true;
      }

      if (!playing) {
        playControl.start();
        guitarEngine.start();
        playing = true;
      } else {
        playControl.stop();
        guitarEngine.stop(); // TODO: remove if empty
        playing = false;
      }

      button.querySelector('i').classList.toggle('icon-play');
      button.querySelector('i').classList.toggle('icon-stop');
    });

    // Input module listener
    if (energy.isValid) {
      input.addListener('energy', function (val) {
        guitarEngine.onEnergy(val);
      });
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,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QztBQUNwQixlQUFPLEdBQUcsS0FBSyxDQUFDO09BQ2pCOztBQUVELFlBQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN4RCxZQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDekQsQ0FBQyxDQUFDOzs7QUFHSCxRQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7QUFDbEIsV0FBSyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsVUFBQyxHQUFHLEVBQUs7QUFDbkMsb0JBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDNUIsQ0FBQyxDQUFDO0tBQ0o7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFBLEVBQUUsQ0FBRSIsImZpbGUiOiJzcmMvc2Nzcy9tYWluLnNjc3MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIEludGVyYWN0aXZlIHZlcnNpb24gb2YgRGFmdCBQdW5rJ3MgTG9zZSBZb3Vyc2VsZiBUbyBEYW5jZS5cbiAqIEBhdXRob3IgU8OpYmFzdGllbiBSb2Jhc3praWV3aWN6IFtoZWxsb0Byb2JpLm1lXVxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuLy8gTGlicmFyaWVzIGFuZCBmaWxlc1xuY29uc3QgYXVkaW9Db250ZXh0ID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5hdWRpb0NvbnRleHQ7XG5jb25zdCBEb3ROYXYgPSByZXF1aXJlKCcuL0RvdE5hdicpO1xuY29uc3QgR3VpdGFyRW5naW5lID0gcmVxdWlyZSgnLi9HdWl0YXJFbmdpbmUnKTtcbmNvbnN0IGlucHV0ID0gcmVxdWlyZSgnbW90aW9uLWlucHV0Jyk7XG5jb25zdCBTdXBlckxvYWRlciA9IHJlcXVpcmUoJ3dhdmVzLWxvYWRlcnMnKS5TdXBlckxvYWRlcjtcbmNvbnN0IFBsYXlDb250cm9sID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5QbGF5Q29udHJvbDtcbmNvbnN0IFBsYXllckVuZ2luZSA9IHJlcXVpcmUoJ3dhdmVzLWF1ZGlvJykuUGxheWVyRW5naW5lO1xuY29uc3QgVHJhbnNwb3J0ID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5UcmFuc3BvcnQ7XG5cbi8vIEhlbHBlciBmdW5jdGlvbnNcbmZ1bmN0aW9uIHN0YXJ0V2ViQXVkaW8oKSB7XG4gIGNvbnN0IG8gPSBhdWRpb0NvbnRleHQuY3JlYXRlT3NjaWxsYXRvcigpO1xuICBjb25zdCBnID0gYXVkaW9Db250ZXh0LmNyZWF0ZUdhaW4oKTtcbiAgY29uc3Qgbm93ID0gYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lO1xuICBvLmNvbm5lY3QoZyk7XG4gIGcuY29ubmVjdChhdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuICBvLnN0YXJ0KG5vdyk7XG4gIG8uc3RvcChub3cgKyAwLjAwMDAwMSk7XG59XG5cbi8vIEhlbHBlciB2YXJpYWJsZXNcbmxldCB3ZWJBdWRpb1N0YXJ0ZWQgPSBmYWxzZTtcbmxldCBwbGF5aW5nID0gZmFsc2U7XG5cbi8vIEluaXRpYWxpemF0aW9uICYgY29uc3RhbnRzXG5jb25zdCBsb2FkZXIgPSBuZXcgU3VwZXJMb2FkZXIoKTtcbmNvbnN0IG9mZnNldCA9IDIuNDAwO1xuY29uc3QgcGVyaW9kID0gMC4xNTA7XG5cbi8vIFNjcmlwdFxuKGZ1bmN0aW9uKCkge1xuICAvLyBQcmV2ZW50IHNjcm9sbGluZ1xuICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIChlKSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9KTtcblxuXG4gIFByb21pc2UuYWxsKFtcbiAgICBsb2FkZXIubG9hZChbJ2Fzc2V0cy9iYWNrdHJhY2subXAzJywgJ2Fzc2V0cy9ndWl0YXIubXAzJywgJ2Fzc2V0cy9ndWl0YXItbWFya2Vycy5qc29uJ10pLFxuICAgIGlucHV0LmluaXQoJ2VuZXJneScpXG4gIF0pLnRoZW4oKFtsb2FkZWRGaWxlcywgaW5wdXRNb2R1bGVzXSkgPT4ge1xuICAgIC8vIEZpbGVzIGFuZCBlbmVyZ3kgbW9kdWxlXG4gICAgY29uc3QgYmFja3RyYWNrQnVmZmVyID0gbG9hZGVkRmlsZXNbMF07XG4gICAgY29uc3QgZ3VpdGFyQnVmZmVyID0gbG9hZGVkRmlsZXNbMV07XG4gICAgY29uc3QgZ3VpdGFyTWFya2VycyA9IGxvYWRlZEZpbGVzWzJdO1xuICAgIGNvbnN0IGVuZXJneSA9IGlucHV0TW9kdWxlc1swXTtcblxuICAgIC8vIFBsYXllciBlbmdpbmUgKGJhY2t0cmFjaylcbiAgICBjb25zdCBiYWNrdHJhY2tQbGF5ZXIgPSBuZXcgUGxheWVyRW5naW5lKHtcbiAgICAgIGJ1ZmZlcjogYmFja3RyYWNrQnVmZmVyLFxuICAgICAgZ2FpbjogMC41XG4gICAgfSk7XG4gICAgYmFja3RyYWNrUGxheWVyLmNvbm5lY3QoYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgIC8vIEluc3RydW1lbnQgZW5naW5lIChndWl0YXIpXG4gICAgY29uc3QgZ3VpdGFyRW5naW5lID0gbmV3IEd1aXRhckVuZ2luZSh7XG4gICAgICBhdWRpb0J1ZmZlcjogZ3VpdGFyQnVmZmVyLFxuICAgICAgbW9kZTogMCxcbiAgICAgIG9mZnNldDogb2Zmc2V0LFxuICAgICAgcGVyaW9kOiBwZXJpb2QsXG4gICAgICBzZWdtZW50TWFya2VyczogZ3VpdGFyTWFya2Vyc1xuICAgIH0pO1xuICAgIGd1aXRhckVuZ2luZS5jb25uZWN0KGF1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XG5cbiAgICAvLyBUcmFuc3BvcnRcbiAgICBjb25zdCB0cmFuc3BvcnQgPSBuZXcgVHJhbnNwb3J0KCk7XG4gICAgdHJhbnNwb3J0LmFkZChiYWNrdHJhY2tQbGF5ZXIsIDAsIEluZmluaXR5KTtcbiAgICB0cmFuc3BvcnQuYWRkKGd1aXRhckVuZ2luZSwgMCwgSW5maW5pdHkpO1xuXG4gICAgLy8gUGxheSBjb250cm9sXG4gICAgY29uc3QgcGxheUNvbnRyb2wgPSBuZXcgUGxheUNvbnRyb2wodHJhbnNwb3J0KTtcblxuICAgIC8vIERvdCBuYXZpZ2F0aW9uXG4gICAgY29uc3QgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRvdC1uYXYnKTtcbiAgICBjb25zdCBkb3ROYXYgPSBuZXcgRG90TmF2KHtcbiAgICAgIGNhbGxiYWNrOiBndWl0YXJFbmdpbmUuY2hhbmdlTW9kZS5iaW5kKGd1aXRhckVuZ2luZSksXG4gICAgICBuYXY6IG5hdixcbiAgICAgIHNlbGVjdGVkOiAxXG4gICAgfSk7XG5cbiAgICAvLyBCdXR0b25cbiAgICBsZXQgYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J1dHRvbicpO1xuICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIGlmICghd2ViQXVkaW9TdGFydGVkKSB7XG4gICAgICAgIHN0YXJ0V2ViQXVkaW8oKTtcbiAgICAgICAgd2ViQXVkaW9TdGFydGVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFwbGF5aW5nKSB7XG4gICAgICAgIHBsYXlDb250cm9sLnN0YXJ0KCk7XG4gICAgICAgIGd1aXRhckVuZ2luZS5zdGFydCgpO1xuICAgICAgICBwbGF5aW5nID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBsYXlDb250cm9sLnN0b3AoKTtcbiAgICAgICAgZ3VpdGFyRW5naW5lLnN0b3AoKTsgLy8gVE9ETzogcmVtb3ZlIGlmIGVtcHR5XG4gICAgICAgIHBsYXlpbmcgPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgYnV0dG9uLnF1ZXJ5U2VsZWN0b3IoJ2knKS5jbGFzc0xpc3QudG9nZ2xlKCdpY29uLXBsYXknKTtcbiAgICAgIGJ1dHRvbi5xdWVyeVNlbGVjdG9yKCdpJykuY2xhc3NMaXN0LnRvZ2dsZSgnaWNvbi1zdG9wJyk7XG4gICAgfSk7XG5cbiAgICAvLyBJbnB1dCBtb2R1bGUgbGlzdGVuZXJcbiAgICBpZiAoZW5lcmd5LmlzVmFsaWQpIHtcbiAgICAgIGlucHV0LmFkZExpc3RlbmVyKCdlbmVyZ3knLCAodmFsKSA9PiB7XG4gICAgICAgIGd1aXRhckVuZ2luZS5vbkVuZXJneSh2YWwpO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn0oKSk7XG4iXX0=