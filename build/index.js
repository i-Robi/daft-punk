/**
 * @file Interactive version of Daft Punk's Lose Yourself To Dance.
 * @author SÃ©bastien Robaszkiewicz [hello@robi.me]
 */

'use strict';

// Libraries and files

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var audioContext = require('waves-audio').audioContext;
var DotNav = require('./DotNav');
var GuitarEngine = require('./GuitarEngine');
var input = require('motion-input');
var SuperLoader = require('waves-loaders').SuperLoader;
var PlayControl = require('waves-audio').PlayControl;
var PlayerEngine = require('waves-audio').PlayerEngine;
var Scratch = require('./Scratch');
var Transport = require('waves-audio').Transport;

// Helper functions
function startWebAudio() {
  var o = audioContext.createOscillator();
  var g = audioContext.createGain();
  var now = audioContext.currentTime;
  o.connect(g);
  g.connect(audioContext.destination);
  o.start(now);
  o.stop(now + 0.000001);
}

// Helper variables
var webAudioStarted = false;
var playing = false;
var timeout = null;

// Constants (song specific)
var mode = 0;
var offset = 2.400;
var period = 0.150;

// Script
(function () {
  var loader = new SuperLoader();

  // Prevent scrolling
  document.body.addEventListener('touchmove', function (e) {
    e.preventDefault();
  });

  _Promise.all([loader.load(['assets/backtrack.mp3', 'assets/guitar.mp3', 'assets/guitar-markers.json']), input.init('energy')]).then(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2);

    var loadedFiles = _ref2[0];
    var inputModules = _ref2[1];

    // Files and energy module
    var backtrackBuffer = loadedFiles[0];
    var guitarBuffer = loadedFiles[1];
    var guitarMarkers = loadedFiles[2];
    var energy = inputModules[0];

    // Player engine (backtrack)
    var backtrackPlayer = new PlayerEngine({
      buffer: backtrackBuffer,
      gain: 0.5
    });
    backtrackPlayer.connect(audioContext.destination);

    // Instrument engine (guitar)
    var guitarEngine = new GuitarEngine({
      audioBuffer: guitarBuffer,
      mode: mode,
      numBeats: 200,
      offset: offset,
      period: period,
      segmentMarkers: guitarMarkers
    });
    guitarEngine.connect(audioContext.destination);

    // Transport
    var transport = new Transport();
    transport.add(backtrackPlayer, 0, Infinity);
    transport.add(guitarEngine, 0, Infinity);

    // Play control
    var playControl = new PlayControl(transport);

    // Dot navigation
    var nav = document.querySelector('.dot-nav');
    var dotNav = new DotNav({
      callback: guitarEngine.changeMode.bind(guitarEngine),
      nav: nav,
      selected: mode
    });

    // Button
    var button = document.getElementById('button').querySelector('i');
    button.addEventListener('click', function () {
      if (!webAudioStarted) {
        startWebAudio();
        webAudioStarted = true;
      }

      if (!playing) {
        playControl.start();
        guitarEngine.start();
        playing = true;
        clearTimeout(timeout);
        timeout = setTimeout(function () {
          playControl.stop();
          guitarEngine.stop(); // TODO: remove if empty
          button.classList.toggle('icon-play');
          button.classList.toggle('icon-stop');
          playing = false;
        }, backtrackBuffer.duration * 1000);
      } else {
        playControl.stop();
        guitarEngine.stop(); // TODO: remove if empty
        playing = false;
        clearTimeout(timeout);
      }

      button.classList.toggle('icon-play');
      button.classList.toggle('icon-stop');
    });

    // Toggle loading / button
    document.getElementById('loader').classList.toggle('hidden');
    document.getElementById('button').classList.toggle('hidden');

    // Scratch
    var scratch = new Scratch();
    scratch.on('scratch', function (val) {
      guitarEngine.onScratch(val);
    });

    // Input module listener
    var instr = document.querySelector('.instructions');
    if (energy.isValid) {
      instr.innerHTML = 'hit &lsquo;play&rsquo; and shake your device\n        </br>(or scratch the screen)';
      input.addListener('energy', function (val) {
        guitarEngine.onEnergy(val);
      });
    } else if ('ontouchstart' in window) {
      instr.innerHTML = 'hit &lsquo;play&rsquo; and scratch the screen';
    } else {
      instr.innerHTML = 'hit &lsquo;play&rsquo; and move your mouse';
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,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QUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUM3QixDQUFDLENBQUM7OztBQUdILFFBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDckQsUUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQ2xCLFdBQUssQ0FBQyxTQUFTLHVGQUNnQixDQUFDO0FBQ2hDLFdBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLFVBQUMsR0FBRyxFQUFLO0FBQ25DLG9CQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO09BQzVCLENBQUMsQ0FBQztLQUNKLE1BQU0sSUFBSSxjQUFjLElBQUksTUFBTSxFQUFFO0FBQ25DLFdBQUssQ0FBQyxTQUFTLEdBQUcsK0NBQStDLENBQUM7S0FDbkUsTUFBTTtBQUNMLFdBQUssQ0FBQyxTQUFTLEdBQUcsNENBQTRDLENBQUM7S0FDaEU7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFBLEVBQUUsQ0FBRSIsImZpbGUiOiJzcmMvc2Nzcy9tYWluLnNjc3MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIEludGVyYWN0aXZlIHZlcnNpb24gb2YgRGFmdCBQdW5rJ3MgTG9zZSBZb3Vyc2VsZiBUbyBEYW5jZS5cbiAqIEBhdXRob3IgU8OpYmFzdGllbiBSb2Jhc3praWV3aWN6IFtoZWxsb0Byb2JpLm1lXVxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuLy8gTGlicmFyaWVzIGFuZCBmaWxlc1xuY29uc3QgYXVkaW9Db250ZXh0ID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5hdWRpb0NvbnRleHQ7XG5jb25zdCBEb3ROYXYgPSByZXF1aXJlKCcuL0RvdE5hdicpO1xuY29uc3QgR3VpdGFyRW5naW5lID0gcmVxdWlyZSgnLi9HdWl0YXJFbmdpbmUnKTtcbmNvbnN0IGlucHV0ID0gcmVxdWlyZSgnbW90aW9uLWlucHV0Jyk7XG5jb25zdCBTdXBlckxvYWRlciA9IHJlcXVpcmUoJ3dhdmVzLWxvYWRlcnMnKS5TdXBlckxvYWRlcjtcbmNvbnN0IFBsYXlDb250cm9sID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5QbGF5Q29udHJvbDtcbmNvbnN0IFBsYXllckVuZ2luZSA9IHJlcXVpcmUoJ3dhdmVzLWF1ZGlvJykuUGxheWVyRW5naW5lO1xuY29uc3QgU2NyYXRjaCA9IHJlcXVpcmUoJy4vU2NyYXRjaCcpO1xuY29uc3QgVHJhbnNwb3J0ID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKS5UcmFuc3BvcnQ7XG5cbi8vIEhlbHBlciBmdW5jdGlvbnNcbmZ1bmN0aW9uIHN0YXJ0V2ViQXVkaW8oKSB7XG4gIGNvbnN0IG8gPSBhdWRpb0NvbnRleHQuY3JlYXRlT3NjaWxsYXRvcigpO1xuICBjb25zdCBnID0gYXVkaW9Db250ZXh0LmNyZWF0ZUdhaW4oKTtcbiAgY29uc3Qgbm93ID0gYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lO1xuICBvLmNvbm5lY3QoZyk7XG4gIGcuY29ubmVjdChhdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuICBvLnN0YXJ0KG5vdyk7XG4gIG8uc3RvcChub3cgKyAwLjAwMDAwMSk7XG59XG5cbi8vIEhlbHBlciB2YXJpYWJsZXNcbmxldCB3ZWJBdWRpb1N0YXJ0ZWQgPSBmYWxzZTtcbmxldCBwbGF5aW5nID0gZmFsc2U7XG5sZXQgdGltZW91dCA9IG51bGw7XG5cbi8vIENvbnN0YW50cyAoc29uZyBzcGVjaWZpYylcbmNvbnN0IG1vZGUgPSAwO1xuY29uc3Qgb2Zmc2V0ID0gMi40MDA7XG5jb25zdCBwZXJpb2QgPSAwLjE1MDtcblxuLy8gU2NyaXB0XG4oZnVuY3Rpb24oKSB7XG4gIGNvbnN0IGxvYWRlciA9IG5ldyBTdXBlckxvYWRlcigpO1xuXG4gIC8vIFByZXZlbnQgc2Nyb2xsaW5nXG4gIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgKGUpID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0pO1xuXG4gIFByb21pc2UuYWxsKFtcbiAgICBsb2FkZXIubG9hZChbJ2Fzc2V0cy9iYWNrdHJhY2subXAzJywgJ2Fzc2V0cy9ndWl0YXIubXAzJywgJ2Fzc2V0cy9ndWl0YXItbWFya2Vycy5qc29uJ10pLFxuICAgIGlucHV0LmluaXQoJ2VuZXJneScpXG4gIF0pLnRoZW4oKFtsb2FkZWRGaWxlcywgaW5wdXRNb2R1bGVzXSkgPT4ge1xuICAgIC8vIEZpbGVzIGFuZCBlbmVyZ3kgbW9kdWxlXG4gICAgY29uc3QgYmFja3RyYWNrQnVmZmVyID0gbG9hZGVkRmlsZXNbMF07XG4gICAgY29uc3QgZ3VpdGFyQnVmZmVyID0gbG9hZGVkRmlsZXNbMV07XG4gICAgY29uc3QgZ3VpdGFyTWFya2VycyA9IGxvYWRlZEZpbGVzWzJdO1xuICAgIGNvbnN0IGVuZXJneSA9IGlucHV0TW9kdWxlc1swXTtcblxuICAgIC8vIFBsYXllciBlbmdpbmUgKGJhY2t0cmFjaylcbiAgICBjb25zdCBiYWNrdHJhY2tQbGF5ZXIgPSBuZXcgUGxheWVyRW5naW5lKHtcbiAgICAgIGJ1ZmZlcjogYmFja3RyYWNrQnVmZmVyLFxuICAgICAgZ2FpbjogMC41XG4gICAgfSk7XG4gICAgYmFja3RyYWNrUGxheWVyLmNvbm5lY3QoYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgIC8vIEluc3RydW1lbnQgZW5naW5lIChndWl0YXIpXG4gICAgY29uc3QgZ3VpdGFyRW5naW5lID0gbmV3IEd1aXRhckVuZ2luZSh7XG4gICAgICBhdWRpb0J1ZmZlcjogZ3VpdGFyQnVmZmVyLFxuICAgICAgbW9kZTogbW9kZSxcbiAgICAgIG51bUJlYXRzOiAyMDAsXG4gICAgICBvZmZzZXQ6IG9mZnNldCxcbiAgICAgIHBlcmlvZDogcGVyaW9kLFxuICAgICAgc2VnbWVudE1hcmtlcnM6IGd1aXRhck1hcmtlcnNcbiAgICB9KTtcbiAgICBndWl0YXJFbmdpbmUuY29ubmVjdChhdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuXG4gICAgLy8gVHJhbnNwb3J0XG4gICAgY29uc3QgdHJhbnNwb3J0ID0gbmV3IFRyYW5zcG9ydCgpO1xuICAgIHRyYW5zcG9ydC5hZGQoYmFja3RyYWNrUGxheWVyLCAwLCBJbmZpbml0eSk7XG4gICAgdHJhbnNwb3J0LmFkZChndWl0YXJFbmdpbmUsIDAsIEluZmluaXR5KTtcblxuICAgIC8vIFBsYXkgY29udHJvbFxuICAgIGNvbnN0IHBsYXlDb250cm9sID0gbmV3IFBsYXlDb250cm9sKHRyYW5zcG9ydCk7XG5cbiAgICAvLyBEb3QgbmF2aWdhdGlvblxuICAgIGNvbnN0IG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kb3QtbmF2Jyk7XG4gICAgY29uc3QgZG90TmF2ID0gbmV3IERvdE5hdih7XG4gICAgICBjYWxsYmFjazogZ3VpdGFyRW5naW5lLmNoYW5nZU1vZGUuYmluZChndWl0YXJFbmdpbmUpLFxuICAgICAgbmF2OiBuYXYsXG4gICAgICBzZWxlY3RlZDogbW9kZVxuICAgIH0pO1xuXG4gICAgLy8gQnV0dG9uXG4gICAgbGV0IGJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidXR0b24nKS5xdWVyeVNlbGVjdG9yKCdpJyk7XG4gICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgaWYgKCF3ZWJBdWRpb1N0YXJ0ZWQpIHtcbiAgICAgICAgc3RhcnRXZWJBdWRpbygpO1xuICAgICAgICB3ZWJBdWRpb1N0YXJ0ZWQgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXBsYXlpbmcpIHtcbiAgICAgICAgcGxheUNvbnRyb2wuc3RhcnQoKTtcbiAgICAgICAgZ3VpdGFyRW5naW5lLnN0YXJ0KCk7XG4gICAgICAgIHBsYXlpbmcgPSB0cnVlO1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBwbGF5Q29udHJvbC5zdG9wKCk7XG4gICAgICAgICAgZ3VpdGFyRW5naW5lLnN0b3AoKTsgLy8gVE9ETzogcmVtb3ZlIGlmIGVtcHR5XG4gICAgICAgICAgYnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoJ2ljb24tcGxheScpO1xuICAgICAgICAgIGJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCdpY29uLXN0b3AnKTtcbiAgICAgICAgICBwbGF5aW5nID0gZmFsc2U7XG4gICAgICAgIH0sIGJhY2t0cmFja0J1ZmZlci5kdXJhdGlvbiAqIDEwMDApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwbGF5Q29udHJvbC5zdG9wKCk7XG4gICAgICAgIGd1aXRhckVuZ2luZS5zdG9wKCk7IC8vIFRPRE86IHJlbW92ZSBpZiBlbXB0eVxuICAgICAgICBwbGF5aW5nID0gZmFsc2U7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgIH1cblxuICAgICAgYnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoJ2ljb24tcGxheScpO1xuICAgICAgYnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoJ2ljb24tc3RvcCcpO1xuICAgIH0pO1xuXG4gICAgLy8gVG9nZ2xlIGxvYWRpbmcgLyBidXR0b25cbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGVyJykuY2xhc3NMaXN0LnRvZ2dsZSgnaGlkZGVuJyk7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J1dHRvbicpLmNsYXNzTGlzdC50b2dnbGUoJ2hpZGRlbicpO1xuXG4gICAgLy8gU2NyYXRjaFxuICAgIGNvbnN0IHNjcmF0Y2ggPSBuZXcgU2NyYXRjaCgpO1xuICAgIHNjcmF0Y2gub24oJ3NjcmF0Y2gnLCAodmFsKSA9PiB7XG4gICAgICBndWl0YXJFbmdpbmUub25TY3JhdGNoKHZhbCk7XG4gICAgfSk7XG5cbiAgICAvLyBJbnB1dCBtb2R1bGUgbGlzdGVuZXJcbiAgICBjb25zdCBpbnN0ciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5pbnN0cnVjdGlvbnMnKVxuICAgIGlmIChlbmVyZ3kuaXNWYWxpZCkge1xuICAgICAgaW5zdHIuaW5uZXJIVE1MID0gYGhpdCAmbHNxdW87cGxheSZyc3F1bzsgYW5kIHNoYWtlIHlvdXIgZGV2aWNlXG4gICAgICAgIDwvYnI+KG9yIHNjcmF0Y2ggdGhlIHNjcmVlbilgO1xuICAgICAgaW5wdXQuYWRkTGlzdGVuZXIoJ2VuZXJneScsICh2YWwpID0+IHtcbiAgICAgICAgZ3VpdGFyRW5naW5lLm9uRW5lcmd5KHZhbCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykge1xuICAgICAgaW5zdHIuaW5uZXJIVE1MID0gJ2hpdCAmbHNxdW87cGxheSZyc3F1bzsgYW5kIHNjcmF0Y2ggdGhlIHNjcmVlbic7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc3RyLmlubmVySFRNTCA9ICdoaXQgJmxzcXVvO3BsYXkmcnNxdW87IGFuZCBtb3ZlIHlvdXIgbW91c2UnO1xuICAgIH1cbiAgfSk7XG59KCkpO1xuIl19